datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String            @id @default(uuid())
  email              String            @unique
  password_hash      String
  display_name       String
  avatar_url         String?
  created_at         DateTime          @default(now())
  
  // Gamification fields
  xp                 Int               @default(0)
  level              Int               @default(1)
  coins              Int               @default(0)
  theme_name         String            @default("classic")
  accent_color       String            @default("#6366F1")
  font_family        String            @default("inter")
  widget_order       String            @default("xp,habits,stats,suggestions")
  is_profile_public  Boolean           @default(true)

  habits             Habit[]
  completions        Completion[]
  group_memberships  GroupMember[]
  notification_pref  NotificationPref?
  created_groups     Group[]           @relation("GroupCreator")
  achievements       UserAchievement[]
  streaks            Streak[]
  powerups           UserPowerup[]
  analytics          Analytics?
  
  // Social relations
  sent_requests      FriendRequest[]   @relation("SentRequests")
  received_requests  FriendRequest[]   @relation("ReceivedRequests")
  friends            Friendship[]      @relation("UserFriends")
  friend_of          Friendship[]      @relation("FriendOf")
  social_activities  SocialActivity[]
  reactions          Reaction[]
  comments           Comment[]
  challenge_memberships ChallengeMember[]
}

model Habit {
  id          String       @id @default(uuid())
  user_id     String
  title       String
  description String?
  frequency   Frequency    @default(DAILY)
  color       String       @default("#6366F1")
  icon        String       @default("target")
  background_image String?
  is_active   Boolean      @default(true)
  created_at  DateTime     @default(now())

  user        User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  completions Completion[]
  streaks     Streak[]
}

enum Frequency {
  DAILY
  WEEKLY
  WEEKDAYS
}

model Completion {
  id             String   @id @default(uuid())
  habit_id       String
  user_id        String
  completed_date DateTime
  created_at     DateTime @default(now())

  habit          Habit    @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([habit_id, completed_date])
}


model Group {
  id          String        @id @default(uuid())
  name        String
  description String?
  invite_code String        @unique @default(cuid())
  created_by  String
  created_at  DateTime      @default(now())

  creator     User          @relation("GroupCreator", fields: [created_by], references: [id], onDelete: Cascade)
  members     GroupMember[]
  challenges  Challenge[]
}

// ... existing models ...

model Challenge {
  id                String            @id @default(uuid())
  group_id          String
  title             String
  description       String?
  start_date        DateTime
  end_date          DateTime
  target_habit_type String?           // e.g., "Any", "Fitness", "Reading"
  goal_count        Int               @default(0) // target number of completions
  xp_reward         Int               @default(50)
  coin_reward       Int               @default(25)
  created_at        DateTime          @default(now())

  group             Group             @relation(fields: [group_id], references: [id], onDelete: Cascade)
  participants      ChallengeMember[]
}

model ChallengeMember {
  id             String    @id @default(uuid())
  challenge_id   String
  user_id        String
  progress_count Int       @default(0)
  is_completed   Boolean   @default(false)
  completed_at   DateTime?
  joined_at      DateTime  @default(now())

  challenge      Challenge @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([challenge_id, user_id])
}

model GroupMember {
  id        String    @id @default(uuid())
  group_id  String
  user_id   String
  role      GroupRole @default(MEMBER)
  joined_at DateTime  @default(now())

  group     Group     @relation(fields: [group_id], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([group_id, user_id])
}

enum GroupRole {
  OWNER
  MEMBER
}


model NotificationPref {
  id            String   @id @default(uuid())
  user_id       String   @unique
  email_alerts  Boolean  @default(true)
  push_alerts   Boolean  @default(true)
  reminder_time String   @default("09:00")

  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// Gamification Models

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String
  icon        String
  category    AchievementCategory
  xp_reward   Int                 @default(0)
  coin_reward Int                 @default(0)
  created_at  DateTime            @default(now())
  
  users       UserAchievement[]
}

enum AchievementCategory {
  STREAK
  COMPLETION
  SOCIAL
  MILESTONE
  SPECIAL
}

model UserAchievement {
  id             String      @id @default(uuid())
  user_id        String
  achievement_id String
  unlocked_at    DateTime    @default(now())
  
  user           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  achievement    Achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, achievement_id])
}

model Streak {
  id              String    @id @default(uuid())
  user_id         String
  habit_id        String
  current_count   Int       @default(0)
  longest_count   Int       @default(0)
  last_completed  DateTime?
  started_at      DateTime  @default(now())
  
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  habit           Habit     @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, habit_id])
}

model Powerup {
  id          String        @id @default(uuid())
  key         String        @unique
  name        String
  description String
  icon        String
  cost_coins  Int
  created_at  DateTime      @default(now())
  
  users       UserPowerup[]
}

model UserPowerup {
  id         String    @id @default(uuid())
  user_id    String
  powerup_id String
  quantity   Int       @default(0)
  
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  powerup    Powerup   @relation(fields: [powerup_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, powerup_id])
}

model Analytics {
  id                String   @id @default(uuid())
  user_id           String   @unique
  best_streak       Int      @default(0)
  total_completions Int      @default(0)
  average_completions_per_week Float @default(0)
  most_productive_day String? // e.g., "Monday"
  most_productive_time String? // e.g., "Morning"
  last_updated      DateTime @default(now())
  
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// Social Models

model FriendRequest {
  id           String             @id @default(uuid())
  sender_id    String
  receiver_id  String
  status       FriendRequestStatus @default(PENDING)
  created_at   DateTime           @default(now())
  updated_at   DateTime           @updatedAt

  sender       User @relation("SentRequests", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver     User @relation("ReceivedRequests", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@unique([sender_id, receiver_id])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Friendship {
  id         String   @id @default(uuid())
  user_id    String
  friend_id  String
  created_at DateTime @default(now())

  user       User @relation("UserFriends", fields: [user_id], references: [id], onDelete: Cascade)
  friend     User @relation("FriendOf", fields: [friend_id], references: [id], onDelete: Cascade)

  @@unique([user_id, friend_id])
}

model SocialActivity {
  id             String       @id @default(uuid())
  user_id        String
  type           ActivityType
  content_id     String?      // ID of habit, achievement, or powerup
  content_text   String?      // Description of the activity
  metadata       Json?        // Flexible storage for activity-specific data
  created_at     DateTime     @default(now())

  user           User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  reactions      Reaction[]
  comments       Comment[]
}

enum ActivityType {
  HABIT_COMPLETED
  LEVEL_UP
  ACHIEVEMENT_UNLOCKED
  STREAK_MILESTONE
}

model Reaction {
  id           String         @id @default(uuid())
  activity_id  String
  user_id      String
  type         String         @default("LIKE") // "LIKE", "FIRE", "CELEBRATE", etc.
  created_at   DateTime       @default(now())

  activity     SocialActivity @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([activity_id, user_id, type])
}

model Comment {
  id           String         @id @default(uuid())
  activity_id  String
  user_id      String
  content      String
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt

  activity     SocialActivity @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
