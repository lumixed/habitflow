datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String            @id @default(uuid())
  email              String            @unique
  password_hash      String
  display_name       String
  avatar_url         String?
  created_at         DateTime          @default(now())
  
  // Gamification fields
  xp                 Int               @default(0)
  level              Int               @default(1)
  coins              Int               @default(0)

  habits             Habit[]
  completions        Completion[]
  group_memberships  GroupMember[]
  notification_pref  NotificationPref?
  created_groups     Group[]           @relation("GroupCreator")
  achievements       UserAchievement[]
  streaks            Streak[]
  powerups           UserPowerup[]
  analytics          Analytics?
}

model Habit {
  id          String       @id @default(uuid())
  user_id     String
  title       String
  description String?
  frequency   Frequency    @default(DAILY)
  color       String       @default("#6366F1")
  icon        String       @default("target")
  is_active   Boolean      @default(true)
  created_at  DateTime     @default(now())

  user        User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  completions Completion[]
  streaks     Streak[]
}

enum Frequency {
  DAILY
  WEEKLY
  WEEKDAYS
}

model Completion {
  id             String   @id @default(uuid())
  habit_id       String
  user_id        String
  completed_date DateTime
  created_at     DateTime @default(now())

  habit          Habit    @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([habit_id, completed_date])
}


model Group {
  id          String        @id @default(uuid())
  name        String
  description String?
  invite_code String        @unique @default(cuid())
  created_by  String
  created_at  DateTime      @default(now())

  creator     User          @relation("GroupCreator", fields: [created_by], references: [id], onDelete: Cascade)
  members     GroupMember[]
}

model GroupMember {
  id        String    @id @default(uuid())
  group_id  String
  user_id   String
  role      GroupRole @default(MEMBER)
  joined_at DateTime  @default(now())

  group     Group     @relation(fields: [group_id], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([group_id, user_id])
}

enum GroupRole {
  OWNER
  MEMBER
}


model NotificationPref {
  id            String   @id @default(uuid())
  user_id       String   @unique
  email_alerts  Boolean  @default(true)
  push_alerts   Boolean  @default(true)
  reminder_time String   @default("09:00")

  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// Gamification Models

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String
  icon        String
  category    AchievementCategory
  xp_reward   Int                 @default(0)
  coin_reward Int                 @default(0)
  created_at  DateTime            @default(now())
  
  users       UserAchievement[]
}

enum AchievementCategory {
  STREAK
  COMPLETION
  SOCIAL
  MILESTONE
  SPECIAL
}

model UserAchievement {
  id             String      @id @default(uuid())
  user_id        String
  achievement_id String
  unlocked_at    DateTime    @default(now())
  
  user           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  achievement    Achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, achievement_id])
}

model Streak {
  id              String    @id @default(uuid())
  user_id         String
  habit_id        String
  current_count   Int       @default(0)
  longest_count   Int       @default(0)
  last_completed  DateTime?
  started_at      DateTime  @default(now())
  
  user            User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  habit           Habit     @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, habit_id])
}

model Powerup {
  id          String        @id @default(uuid())
  key         String        @unique
  name        String
  description String
  icon        String
  cost_coins  Int
  created_at  DateTime      @default(now())
  
  users       UserPowerup[]
}

model UserPowerup {
  id         String    @id @default(uuid())
  user_id    String
  powerup_id String
  quantity   Int       @default(0)
  
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  powerup    Powerup   @relation(fields: [powerup_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, powerup_id])
}

model Analytics {
  id                String   @id @default(uuid())
  user_id           String   @unique
  best_streak       Int      @default(0)
  total_completions Int      @default(0)
  average_completions_per_week Float @default(0)
  most_productive_day String? // e.g., "Monday"
  most_productive_time String? // e.g., "Morning"
  last_updated      DateTime @default(now())
  
  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
