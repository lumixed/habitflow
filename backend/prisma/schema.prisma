generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String            @id @default(uuid())
  email                    String            @unique
  password_hash            String
  display_name             String
  avatar_url               String?
  created_at               DateTime          @default(now())
  xp                       Int               @default(0)
  level                    Int               @default(1)
  coins                    Int               @default(0)
  accent_color             String            @default("#6366F1")
  theme_name               String            @default("classic")
  referral_code            String?           @unique
  widget_order             String            @default("xp,habits,stats,suggestions")
  is_profile_public        Boolean           @default(true)
  font_family              String            @default("inter")
  data_retention_days      Int               @default(365)
  is_anonymous             Boolean           @default(false)
  last_export_at           DateTime?
  scheduled_export_enabled Boolean           @default(false)
  two_factor_enabled       Boolean           @default(false)
  two_factor_secret        String?
  analytics                Analytics?
  challenge_memberships    ChallengeMember[]
  comments                 Comment[]
  completions              Completion[]
  received_requests        FriendRequest[]   @relation("ReceivedRequests")
  sent_requests            FriendRequest[]   @relation("SentRequests")
  friend_of                Friendship[]      @relation("FriendOf")
  friends                  Friendship[]      @relation("UserFriends")
  created_groups           Group[]           @relation("GroupCreator")
  group_memberships        GroupMember[]
  habits                   Habit[]
  notification_pref        NotificationPref?
  reactions                Reaction[]
  social_activities        SocialActivity[]
  streaks                  Streak[]
  achievements             UserAchievement[]
  powerups                 UserPowerup[]
  api_keys                 ApiKey[]
  webhooks                 Webhook[]
  external_integrations    ExternalIntegration[]
  referrals_sent           Referral[]        @relation("ReferrerRel")
  referral_received        Referral?         @relation("ReferredRel")
}

model Referral {
  id          String   @id @default(uuid())
  referrer_id String
  referred_id String   @unique
  rewarded    Boolean  @default(false)
  created_at  DateTime @default(now())
  referrer    User     @relation("ReferrerRel", fields: [referrer_id], references: [id])
  referred    User     @relation("ReferredRel", fields: [referred_id], references: [id])

  @@index([referrer_id])
}

model Habit {
  id               String       @id @default(uuid())
  user_id          String
  title            String
  description      String?
  frequency        Frequency    @default(DAILY)
  color            String       @default("#6366F1")
  icon             String       @default("target")
  is_active        Boolean      @default(true)
  created_at       DateTime     @default(now())
  background_image String?
  is_private       Boolean      @default(false)
  completions      Completion[]
  user             User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  streaks          Streak[]
}

model Completion {
  id             String   @id @default(uuid())
  habit_id       String
  user_id        String
  completed_date DateTime
  created_at     DateTime @default(now())
  habit          Habit    @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([habit_id, completed_date])
}

model Group {
  id          String        @id @default(uuid())
  name        String
  description String?
  invite_code String        @unique @default(cuid())
  created_by  String
  created_at  DateTime      @default(now())
  challenges  Challenge[]
  creator     User          @relation("GroupCreator", fields: [created_by], references: [id], onDelete: Cascade)
  members     GroupMember[]
}

model Challenge {
  id                String            @id @default(uuid())
  group_id          String
  title             String
  description       String?
  start_date        DateTime
  end_date          DateTime
  target_habit_type String?
  goal_count        Int               @default(0)
  created_at        DateTime          @default(now())
  coin_reward       Int               @default(25)
  xp_reward         Int               @default(50)
  group             Group             @relation(fields: [group_id], references: [id], onDelete: Cascade)
  participants      ChallengeMember[]
}

model ChallengeMember {
  id             String    @id @default(uuid())
  challenge_id   String
  user_id        String
  progress_count Int       @default(0)
  joined_at      DateTime  @default(now())
  completed_at   DateTime?
  is_completed   Boolean   @default(false)
  challenge      Challenge @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([challenge_id, user_id])
}

model GroupMember {
  id        String    @id @default(uuid())
  group_id  String
  user_id   String
  role      GroupRole @default(MEMBER)
  joined_at DateTime  @default(now())
  group     Group     @relation(fields: [group_id], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([group_id, user_id])
}

model NotificationPref {
  id            String  @id @default(uuid())
  user_id       String  @unique
  email_alerts  Boolean @default(true)
  push_alerts   Boolean @default(true)
  reminder_time String  @default("09:00")
  user          User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String
  icon        String
  category    AchievementCategory
  xp_reward   Int                 @default(0)
  coin_reward Int                 @default(0)
  created_at  DateTime            @default(now())
  users       UserAchievement[]
}

model UserAchievement {
  id             String      @id @default(uuid())
  user_id        String
  achievement_id String
  unlocked_at    DateTime    @default(now())
  achievement    Achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, achievement_id])
}

model Streak {
  id             String    @id @default(uuid())
  user_id        String
  habit_id       String
  current_count  Int       @default(0)
  longest_count  Int       @default(0)
  last_completed DateTime?
  started_at     DateTime  @default(now())
  habit          Habit     @relation(fields: [habit_id], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, habit_id])
}

model Powerup {
  id          String        @id @default(uuid())
  key         String        @unique
  name        String
  description String
  icon        String
  cost_coins  Int
  created_at  DateTime      @default(now())
  users       UserPowerup[]
}

model UserPowerup {
  id         String  @id @default(uuid())
  user_id    String
  powerup_id String
  quantity   Int     @default(0)
  powerup    Powerup @relation(fields: [powerup_id], references: [id], onDelete: Cascade)
  user       User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, powerup_id])
}

model Analytics {
  id                           String   @id @default(uuid())
  user_id                      String   @unique
  best_streak                  Int      @default(0)
  total_completions            Int      @default(0)
  average_completions_per_week Float    @default(0)
  most_productive_day          String?
  most_productive_time         String?
  last_updated                 DateTime @default(now())
  user                         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model FriendRequest {
  id          String              @id @default(uuid())
  sender_id   String
  receiver_id String
  status      FriendRequestStatus @default(PENDING)
  created_at  DateTime            @default(now())
  updated_at  DateTime            @updatedAt
  receiver    User                @relation("ReceivedRequests", fields: [receiver_id], references: [id], onDelete: Cascade)
  sender      User                @relation("SentRequests", fields: [sender_id], references: [id], onDelete: Cascade)

  @@unique([sender_id, receiver_id])
}

model Friendship {
  id         String   @id @default(uuid())
  user_id    String
  friend_id  String
  created_at DateTime @default(now())
  friend     User     @relation("FriendOf", fields: [friend_id], references: [id], onDelete: Cascade)
  user       User     @relation("UserFriends", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, friend_id])
}

model SocialActivity {
  id           String       @id @default(uuid())
  user_id      String
  type         ActivityType
  content_id   String?
  content_text String?
  metadata     Json?
  created_at   DateTime     @default(now())
  comments     Comment[]
  reactions    Reaction[]
  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Reaction {
  id          String         @id @default(uuid())
  activity_id String
  user_id     String
  type        String         @default("LIKE")
  created_at  DateTime       @default(now())
  activity    SocialActivity @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([activity_id, user_id, type])
}

model Comment {
  id          String         @id @default(uuid())
  activity_id String
  user_id     String
  content     String
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  activity    SocialActivity @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model ApiKey {
  id         String    @id @default(uuid())
  user_id    String
  name       String    // e.g., "Mobile App", "Internal Script"
  key_hash   String    @unique
  scopes     String    @default("read,write") // comma-separated scopes
  created_at DateTime  @default(now())
  last_used  DateTime?
  expires_at DateTime?
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model Webhook {
  id         String    @id @default(uuid())
  user_id    String
  url        String
  secret     String    // For signed payloads
  events     String    // Comma-separated list of events: habit.completed, level.up, etc.
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model ExternalIntegration {
  id              String   @id @default(uuid())
  user_id         String
  provider        String   // "google_calendar", "strava", etc.
  access_token    String
  refresh_token   String?
  expires_at      DateTime?
  metadata        Json?    // Provider-specific data (e.g., calendar_id)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, provider])
}

enum Frequency {
  DAILY
  WEEKLY
  WEEKDAYS
}

enum GroupRole {
  OWNER
  MEMBER
}

enum AchievementCategory {
  STREAK
  COMPLETION
  SOCIAL
  MILESTONE
  SPECIAL
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum ActivityType {
  HABIT_COMPLETED
  LEVEL_UP
  ACHIEVEMENT_UNLOCKED
  STREAK_MILESTONE
}
